<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>01 - Simulating data • phyloflows</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="01 - Simulating data">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">phyloflows</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01_simulating_data.html">01 - Simulating data</a>
    </li>
    <li>
      <a href="../articles/02_basic_example.html">02 - Very first example</a>
    </li>
    <li>
      <a href="../articles/03_diagnostics.html">03 - Performing MCMC diagnostic checks</a>
    </li>
    <li>
      <a href="../articles/04_aggregating.html">04 - Aggregating MCMC output to a new set of variables</a>
    </li>
    <li>
      <a href="../articles/05_keyquantities.html">05 - Calculating sources, onward transmissions and flow ratios</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/BDI-pathogens/phyloscanner">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>01 - Simulating data</h1>
            
            <h4 class="date">2019-04-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/BDI-pathogens/phyloscanner/blob/master/vignettes/01_simulating_data.Rmd"><code>vignettes/01_simulating_data.Rmd</code></a></small>
      <div class="hidden name"><code>01_simulating_data.Rmd</code></div>

    </div>

    
    
<p>Here is some code to set up simulated data sets. The main aim of these simulations are to test the performance of phyloflows MCMC algorithm. Please read the sections “Our Job” and “Our Solution” on the main page before you go ahead here.</p>
<div id="data-set-1-simple-sarws" class="section level2">
<h2 class="hasAnchor">
<a href="#data-set-1-simple-sarws" class="anchor"></a>Data set 1 (simple, SARWS)</h2>
<p>We start with simulating transmission flows between two population groups called “1” and “2”. We will assume a very simple sampling process, sampling at random within population strata, which we abbreviate to SARWS.</p>
<p><strong>We first set up the sampling process within the two population groups.</strong> Let us assume population group 1 consists of <span class="math inline">\(2000\)</span> individuals and group 2 of <span class="math inline">\(2500\)</span> individuals, and that the sampling rates are <span class="math inline">\(0.6\)</span> for group 1 and <span class="math inline">\(0.45\)</span> for group 2. Here, we will suppose that sampling is at random within each of the population groups with these two sampling probabilities:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(data.table)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb1-3" title="3">ds &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/data.table.html">data.table</a></span>(<span class="dt">CATEGORY=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="dt">TRIAL=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2000</span>,<span class="dv">2500</span>),<span class="dt">P_SEQ_EMP=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.6</span>,<span class="fl">0.45</span>))</a>
<a class="sourceLine" id="cb1-4" title="4">ds[,SUC<span class="op">:</span><span class="er">=</span>TRIAL<span class="op">*</span>P_SEQ_EMP]</a>
<a class="sourceLine" id="cb1-5" title="5">ds</a></code></pre></div>
<pre><code>##    CATEGORY TRIAL P_SEQ_EMP  SUC
## 1:        1  2000      0.60 1200
## 2:        2  2500      0.45 1125</code></pre>
<p><strong>Next, we calculate the sampling probabilities of transmission flows within and between the two groups.</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">dobs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/data.table.html">data.table</a></span>(<span class="dt">TR_TRM_CATEGORY=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>),<span class="dt">REC_TRM_CATEGORY=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb3-2" title="2">tmp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/subset.data.table.html">subset</a></span>(ds,<span class="dt">select=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'CATEGORY'</span>,<span class="st">'P_SEQ_EMP'</span>))</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setattr.html">setnames</a></span>(tmp,<span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(tmp),<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'TR_TRM_'</span>,<span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(tmp)))</a>
<a class="sourceLine" id="cb3-4" title="4">dobs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/merge.html">merge</a></span>(dobs,tmp,<span class="dt">by=</span><span class="st">'TR_TRM_CATEGORY'</span>)</a>
<a class="sourceLine" id="cb3-5" title="5"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setattr.html">setnames</a></span>(tmp,<span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(tmp),<span class="kw"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">'TR_'</span>,<span class="st">'REC_'</span>,<span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(tmp)))</a>
<a class="sourceLine" id="cb3-6" title="6">dobs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/merge.html">merge</a></span>(dobs,tmp,<span class="dt">by=</span><span class="st">'REC_TRM_CATEGORY'</span>)</a>
<a class="sourceLine" id="cb3-7" title="7">dobs[, S<span class="op">:</span><span class="er">=</span><span class="st"> </span>TR_TRM_P_SEQ_EMP <span class="op">*</span><span class="st"> </span>REC_TRM_P_SEQ_EMP]</a>
<a class="sourceLine" id="cb3-8" title="8"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/assign.html">set</a></span>(dobs, <span class="ot">NULL</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'TR_TRM_P_SEQ_EMP'</span>,<span class="st">'REC_TRM_P_SEQ_EMP'</span>), <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb3-9" title="9"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setkey.html">setkey</a></span>(dobs,TR_TRM_CATEGORY,REC_TRM_CATEGORY)</a>
<a class="sourceLine" id="cb3-10" title="10">dobs</a></code></pre></div>
<pre><code>##    REC_TRM_CATEGORY TR_TRM_CATEGORY      S
## 1:                1               1 0.3600
## 2:                2               1 0.2700
## 3:                1               2 0.2700
## 4:                2               2 0.2025</code></pre>
<p><strong>Next, we simulate true transmission flows.</strong> Let us assume 36% and 54% transmissions are within group 1 and 2 respectively, and 4% are from group 1 to group 2 and 6% are from group 2 to group 1: <span class="math display">\[
\pi=(0.36,0.04,0.06,0.54).
\]</span> We further assume the total number of observed transmissions is <span class="math inline">\(N=300\)</span>. We will simulate the actual transmission count <span class="math inline">\(Z\)</span> from a Poisson distribution. Then we will generate transmission flows between groups by <span class="math display">\[
z \sim \mbox{Multinomial} (Z,\pi).
\]</span> Finally we will generate observed transmissions flows by subsampling the actual transmission flows by <span class="math display">\[
n_{ab} \sim \mbox{Binomial} (z_{ab},\xi_{ab}), \forall a,b,
\]</span> where <span class="math inline">\(\xi_{ab}\)</span> is the probability of sampling a transmission event from <span class="math inline">\(a\)</span> to <span class="math inline">\(b\)</span>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">TRUE_PI &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.36</span>,<span class="fl">0.04</span>,<span class="fl">0.06</span>,<span class="fl">0.54</span>)</a>
<a class="sourceLine" id="cb5-2" title="2">N &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span>(<span class="dv">1</span>,<span class="dv">300</span><span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(dobs<span class="op">$</span>S))</a>
<a class="sourceLine" id="cb5-3" title="3">z &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Multinom.html">rmultinom</a></span>(<span class="dv">1</span>,<span class="dt">size=</span>N,<span class="dt">prob=</span>TRUE_PI)</a>
<a class="sourceLine" id="cb5-4" title="4">n &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="ot">NA_integer_</span>,<span class="dt">ncol=</span><span class="dv">1</span>,<span class="dt">nrow=</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(TRUE_PI))</a>
<a class="sourceLine" id="cb5-5" title="5"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(TRUE_PI)){</a>
<a class="sourceLine" id="cb5-6" title="6">    n[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="dv">1</span>,<span class="dt">size=</span>z[i],dobs<span class="op">$</span>S[i])</a>
<a class="sourceLine" id="cb5-7" title="7">}</a>
<a class="sourceLine" id="cb5-8" title="8">dobs[, TRM_OBS<span class="op">:</span><span class="er">=</span><span class="st"> </span>n]</a>
<a class="sourceLine" id="cb5-9" title="9">dobs</a></code></pre></div>
<pre><code>##    REC_TRM_CATEGORY TR_TRM_CATEGORY      S TRM_OBS
## 1:                1               1 0.3600     139
## 2:                2               1 0.2700      20
## 3:                1               2 0.2700      15
## 4:                2               2 0.2025     129</code></pre>
</div>
<div id="corresponding-phyloflows-input-data-simple-sarws" class="section level2">
<h2 class="hasAnchor">
<a href="#corresponding-phyloflows-input-data-simple-sarws" class="anchor"></a>Corresponding <strong>phyloflows</strong> input data (simple, SARWS)</h2>
<p><strong>We will start by bringing the transmission count data into the form needed for phyloflows MCMC algorithm.</strong> We add an ID to each observation, called <code>TRM_CAT_PAIR_ID</code>. We also define the sampling groups. In this example, they correspond directly to the transmission groups.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">dobs[, TR_SAMPLING_CATEGORY<span class="op">:</span><span class="er">=</span>TR_TRM_CATEGORY]</a>
<a class="sourceLine" id="cb7-2" title="2">dobs[, REC_SAMPLING_CATEGORY<span class="op">:</span><span class="er">=</span>REC_TRM_CATEGORY]</a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setkey.html">setkey</a></span>(dobs,TR_TRM_CATEGORY,REC_TRM_CATEGORY)</a>
<a class="sourceLine" id="cb7-4" title="4">dobs[, TRM_CAT_PAIR_ID<span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(dobs))]</a>
<a class="sourceLine" id="cb7-5" title="5">dobs[, S<span class="op">:</span><span class="er">=</span><span class="ot">NULL</span>]</a>
<a class="sourceLine" id="cb7-6" title="6">dobs</a></code></pre></div>
<pre><code>##    REC_TRM_CATEGORY TR_TRM_CATEGORY TRM_OBS TR_SAMPLING_CATEGORY
## 1:                1               1     139                    1
## 2:                2               1      20                    1
## 3:                1               2      15                    2
## 4:                2               2     129                    2
##    REC_SAMPLING_CATEGORY TRM_CAT_PAIR_ID
## 1:                     1               1
## 2:                     2               2
## 3:                     1               3
## 4:                     2               4</code></pre>
<p><strong>We also need to define the prior distribution on the unknown sampling probabilities, and generate samples from it</strong>. At the very top of this page, defined the number of infected and sampled individuals in data.frame <code>ds</code>. Let us denote these by <span class="math inline">\(X_a^i\)</span> and <span class="math inline">\(X_a^s\)</span> for our two population groups <span class="math inline">\(a\)</span>. Usually this type of information is available to us in real-world data analyses, and so we work from these numbers here also. Under the Binomial sampling model that we assume throughout, <span class="math inline">\(X_a^s\sim Binom(X_a^i, \xi_a)\)</span>. If we suppose a flat prior on <span class="math inline">\(\xi_a\)</span>, we obtain the posterior distribution of the sampling probabilities conditional on the number of total and sampled individuals, <span class="math display">\[
p(\xi_a|X_a^i,X_s^i)= Beta(\xi_a;X_a^s+1,X_a^i-X_a^s+1).
\]</span> This density typically contains a lot of information on the sampling process. To get this information into the form needed for <strong>phyloflows</strong> MCMC algorithm, we need to derive samples from that distribution. We also need to calculate their log density.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">nprior&lt;-<span class="dv">1000</span></a>
<a class="sourceLine" id="cb9-2" title="2">dprior&lt;-ds[,<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">P=</span><span class="kw"><a href="https://rdrr.io/r/stats/Beta.html">rbeta</a></span>(nprior,SUC<span class="op">+</span><span class="dv">1</span>,TRIAL<span class="op">-</span>SUC<span class="op">+</span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb9-3" title="3">         <span class="dt">SAMPLE=</span><span class="dv">1</span><span class="op">:</span>nprior),</a>
<a class="sourceLine" id="cb9-4" title="4">   by=<span class="st">'CATEGORY'</span>]</a>
<a class="sourceLine" id="cb9-5" title="5">dprior&lt;-<span class="kw"><a href="https://rdrr.io/pkg/data.table/man/merge.html">merge</a></span>(dprior,ds,<span class="dt">by=</span><span class="st">'CATEGORY'</span>)</a>
<a class="sourceLine" id="cb9-6" title="6">dprior[,LP<span class="op">:</span><span class="er">=</span><span class="kw"><a href="https://rdrr.io/r/stats/Beta.html">dbeta</a></span>(P,SUC<span class="op">+</span><span class="dv">1</span>,TRIAL<span class="op">-</span>SUC<span class="op">+</span><span class="dv">1</span>,<span class="dt">log=</span><span class="ot">TRUE</span>)]</a>
<a class="sourceLine" id="cb9-7" title="7"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/assign.html">set</a></span>(dprior,<span class="ot">NULL</span>,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'TRIAL'</span>,<span class="st">'SUC'</span>),<span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb9-8" title="8"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setattr.html">setnames</a></span>(dprior, <span class="st">'CATEGORY'</span>, <span class="st">'SAMPLING_CATEGORY'</span>)</a>
<a class="sourceLine" id="cb9-9" title="9"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(dprior)</a></code></pre></div>
<pre><code>##    SAMPLING_CATEGORY         P SAMPLE P_SEQ_EMP       LP
## 1:                 1 0.5824160      1       0.6 2.318750
## 2:                 1 0.6184042      2       0.6 2.168504
## 3:                 1 0.6033518      3       0.6 3.548540
## 4:                 1 0.6015475      4       0.6 3.585452
## 5:                 1 0.5918721      5       0.6 3.321375
## 6:                 1 0.6034198      6       0.6 3.546614</code></pre>
<p>This data set can be loaded through</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(twoGroupFlows1)</a></code></pre></div>
<p>To test our MCMC algorithm, we repeated generated 100 such data set, and they can be loaded through</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(twoGroupFlows100)</a></code></pre></div>
</div>
<div id="data-set-2-more-complex-glm" class="section level2">
<h2 class="hasAnchor">
<a href="#data-set-2-more-complex-glm" class="anchor"></a>Data set 2 (more complex, GLM)</h2>
<p>We are now ready to consider a more complex example! We are still interested in transmission flows between the two groups “1” and “2”. However in real-life sampling may depend on further characteristics of the populations in the two groups “1” and “2”. If this is the case, the above SARWS assumption is obviously violated.</p>
<p><strong>So where do we go from here?</strong> We could consider smaller sub-populations, though this runs the risk that estimates of the sampling probabilities quickly become very uncertain. And we know that if the sampling probabilities are uncertain, the performance of <strong>phyloflows</strong> MCMC engine will take a big hit. To avoid this problem, let us estimate the sampling probabilities for each sub-population based on a linear combination of predictive variables. We call this the GLM approach.</p>
<p>To keep things simple at the start, let us assume that sampling depends on gender within each group “1” and “2”. We consider four population groups, “1M”, “1F”, “2M” and “2F”. Let us assume there are <span class="math inline">\(10,000\)</span> individuals in total, <span class="math inline">\(40\%\)</span> individuals are in location 1, <span class="math inline">\(60\%\)</span> individuals are in location 2, <span class="math inline">\(60\%\)</span> individuals are women within each location, and that the sampling rates are <span class="math inline">\(0.6\)</span> for men in group 1, <span class="math inline">\(0.8\)</span> for women in group 1, <span class="math inline">\(0.3\)</span> for men in group 2 and <span class="math inline">\(0.7\)</span> for women in group 2:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(data.table)</a>
<a class="sourceLine" id="cb13-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>)</a>
<a class="sourceLine" id="cb13-3" title="3">ds &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/data.table.html">data.table</a></span>(<span class="dt">SEX=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'M'</span>,<span class="st">'F'</span>),<span class="dv">2</span>)),</a>
<a class="sourceLine" id="cb13-4" title="4">                 <span class="dt">GROUP=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">2</span>,<span class="dv">2</span>)),</a>
<a class="sourceLine" id="cb13-5" title="5">                 <span class="dt">P_SEQ=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.6</span>,<span class="fl">0.8</span>,<span class="fl">0.3</span>,<span class="fl">0.7</span>)) <span class="co"># set up seq rates</span></a>
<a class="sourceLine" id="cb13-6" title="6"></a>
<a class="sourceLine" id="cb13-7" title="7">ninf &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb13-8" title="8">ninf1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(ninf<span class="op">*</span><span class="fl">0.4</span>)</a>
<a class="sourceLine" id="cb13-9" title="9">ninf2 &lt;-<span class="st"> </span>ninf<span class="op">-</span>ninf1</a>
<a class="sourceLine" id="cb13-10" title="10">ninf1f &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(ninf1<span class="op">*</span><span class="fl">0.7</span>)</a>
<a class="sourceLine" id="cb13-11" title="11">ninf1m &lt;-<span class="st"> </span>ninf1<span class="op">-</span>ninf1f</a>
<a class="sourceLine" id="cb13-12" title="12">ninf2f &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(ninf2<span class="op">*</span><span class="fl">0.6</span>)</a>
<a class="sourceLine" id="cb13-13" title="13">ninf2m &lt;-<span class="st"> </span>ninf2<span class="op">-</span>ninf2f</a>
<a class="sourceLine" id="cb13-14" title="14">ds[,TRIAL<span class="op">:</span><span class="er">=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(ninf1m,ninf1f,ninf2m,ninf2f)]</a>
<a class="sourceLine" id="cb13-15" title="15">ds[,SUC<span class="op">:</span><span class="er">=</span><span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(ds),TRIAL,P_SEQ)]</a>
<a class="sourceLine" id="cb13-16" title="16">ds[,CATEGORY<span class="op">:</span><span class="er">=</span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(GROUP,<span class="st">':'</span>,SEX)]</a></code></pre></div>
<p><strong>Next, we calculate the sampling probabilities of transmission flows within and between the two groups.</strong></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">dobs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/data.table.html">data.table</a></span>(<span class="dt">TR_GROUP=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">1</span>,<span class="dv">4</span>),<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">2</span>,<span class="dv">4</span>)),</a>
<a class="sourceLine" id="cb14-2" title="2">                 <span class="dt">REC_GROUP=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">2</span>,<span class="dv">2</span>),<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">1</span>,<span class="dv">2</span>),<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">2</span>,<span class="dv">2</span>)),</a>
<a class="sourceLine" id="cb14-3" title="3">                 <span class="dt">TR_SEX=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'F'</span>,<span class="st">'M'</span>),<span class="dv">4</span>)),</a>
<a class="sourceLine" id="cb14-4" title="4">                 <span class="dt">REC_SEX=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'M'</span>,<span class="st">'F'</span>),<span class="dv">4</span>)))</a>
<a class="sourceLine" id="cb14-5" title="5">dobs[,TR_TRM_CATEGORY<span class="op">:</span><span class="er">=</span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(TR_GROUP,<span class="st">":"</span>,TR_SEX)]</a>
<a class="sourceLine" id="cb14-6" title="6">dobs[,REC_TRM_CATEGORY<span class="op">:</span><span class="er">=</span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(REC_GROUP,<span class="st">":"</span>,REC_SEX)]</a>
<a class="sourceLine" id="cb14-7" title="7">dobs[, TRM_CAT_PAIR_ID<span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(dobs))]</a>
<a class="sourceLine" id="cb14-8" title="8"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/assign.html">set</a></span>(dobs, <span class="ot">NULL</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'TR_GROUP'</span>,<span class="st">'REC_GROUP'</span>,<span class="st">'TR_SEX'</span>,<span class="st">'REC_SEX'</span>), <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb14-9" title="9">tmp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/subset.data.table.html">subset</a></span>(ds,<span class="dt">select=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'CATEGORY'</span>,<span class="st">'P_SEQ'</span>))</a>
<a class="sourceLine" id="cb14-10" title="10"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setattr.html">setnames</a></span>(tmp,<span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(tmp),<span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">'TR_TRM_'</span>,<span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(tmp)))</a>
<a class="sourceLine" id="cb14-11" title="11">dobs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/merge.html">merge</a></span>(dobs,tmp,<span class="dt">by=</span><span class="st">'TR_TRM_CATEGORY'</span>)</a>
<a class="sourceLine" id="cb14-12" title="12"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setattr.html">setnames</a></span>(tmp,<span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(tmp),<span class="kw"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">'TR_'</span>,<span class="st">'REC_'</span>,<span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(tmp)))</a>
<a class="sourceLine" id="cb14-13" title="13">dobs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/merge.html">merge</a></span>(dobs,tmp,<span class="dt">by=</span><span class="st">'REC_TRM_CATEGORY'</span>)</a>
<a class="sourceLine" id="cb14-14" title="14">dobs[, S<span class="op">:</span><span class="er">=</span><span class="st"> </span>TR_TRM_P_SEQ <span class="op">*</span><span class="st"> </span>REC_TRM_P_SEQ]</a>
<a class="sourceLine" id="cb14-15" title="15"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/assign.html">set</a></span>(dobs, <span class="ot">NULL</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'TR_TRM_P_SEQ'</span>,<span class="st">'REC_TRM_P_SEQ'</span>), <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb14-16" title="16"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setkey.html">setkey</a></span>(dobs,TRM_CAT_PAIR_ID)</a>
<a class="sourceLine" id="cb14-17" title="17">dobs</a></code></pre></div>
<pre><code>##    REC_TRM_CATEGORY TR_TRM_CATEGORY TRM_CAT_PAIR_ID    S
## 1:              1:M             1:F               1 0.48
## 2:              1:F             1:M               2 0.48
## 3:              2:M             1:F               3 0.24
## 4:              2:F             1:M               4 0.42
## 5:              1:M             2:F               5 0.42
## 6:              1:F             2:M               6 0.24
## 7:              2:M             2:F               7 0.21
## 8:              2:F             2:M               8 0.21</code></pre>
<p><strong>Next, we simulate true transmission flows between the sampling groups.</strong> Let us assume that 30% and 45% transmissions occur respectively within the groups “1” and “2”. Further, 10% are from “1” to “2” and 15% are from “2” to “1”. Of all those, 60% originate from men: <span class="math display">\[
\pi=(0.12,0.18,0.04,0.06,0.06,0.09,0.18,0.27).
\]</span> We further assume the total number of observed transmissions is <span class="math inline">\(N=300\)</span>. We will simulate the actual transmission count <span class="math inline">\(Z\)</span> from a Poisson distribution. Then we will generate transmission flows between groups by <span class="math display">\[
z \sim \mbox{Multinomial} (Z,\pi).
\]</span> Finally we will generate observed transmissions flows by subsampling the actual transmission flows by <span class="math display">\[
n_{ab} \sim \mbox{Binomial} (z_{ab},\xi_{ab}), \forall a,b,
\]</span> where <span class="math inline">\(\xi_{ab}\)</span> is the probability of sampling a transmission event from <span class="math inline">\(a\)</span> to <span class="math inline">\(b\)</span>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">TRUE_PI &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.12</span>,<span class="fl">0.18</span>,<span class="fl">0.04</span>,<span class="fl">0.06</span>,<span class="fl">0.06</span>,<span class="fl">0.09</span>,<span class="fl">0.18</span>,<span class="fl">0.27</span>)</a>
<a class="sourceLine" id="cb16-2" title="2">N &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span>(<span class="dv">1</span>,<span class="dv">300</span><span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(dobs<span class="op">$</span>S))</a>
<a class="sourceLine" id="cb16-3" title="3">z &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Multinom.html">rmultinom</a></span>(<span class="dv">1</span>,<span class="dt">size=</span>N,<span class="dt">prob=</span>TRUE_PI)</a>
<a class="sourceLine" id="cb16-4" title="4">n &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="ot">NA_integer_</span>,<span class="dt">ncol=</span><span class="dv">1</span>,<span class="dt">nrow=</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(TRUE_PI))</a>
<a class="sourceLine" id="cb16-5" title="5"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(TRUE_PI)){</a>
<a class="sourceLine" id="cb16-6" title="6">    n[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="dv">1</span>,<span class="dt">size=</span>z[i],dobs<span class="op">$</span>S[i])</a>
<a class="sourceLine" id="cb16-7" title="7">}</a>
<a class="sourceLine" id="cb16-8" title="8">dobs[, TRM_OBS<span class="op">:</span><span class="er">=</span><span class="st"> </span>n]</a>
<a class="sourceLine" id="cb16-9" title="9">dobs&lt;-dobs[TRM_OBS<span class="op">!=</span><span class="dv">0</span>,]</a>
<a class="sourceLine" id="cb16-10" title="10">dobs</a></code></pre></div>
<pre><code>##    REC_TRM_CATEGORY TR_TRM_CATEGORY TRM_CAT_PAIR_ID    S TRM_OBS
## 1:              1:M             1:F               1 0.48      55
## 2:              1:F             1:M               2 0.48      77
## 3:              2:M             1:F               3 0.24       7
## 4:              2:F             1:M               4 0.42      22
## 5:              1:M             2:F               5 0.42      17
## 6:              1:F             2:M               6 0.24      28
## 7:              2:M             2:F               7 0.21      35
## 8:              2:F             2:M               8 0.21      56</code></pre>
</div>
<div id="corresponding-phyloflows-input-data-more-complex-glm" class="section level2">
<h2 class="hasAnchor">
<a href="#corresponding-phyloflows-input-data-more-complex-glm" class="anchor"></a>Corresponding <strong>phyloflows</strong> input data (more complex, GLM)</h2>
<p><strong>We start again by bringing the transmission count data into the form needed for phyloflows MCMC algorithm.</strong> We add an ID to each observation, called <code>TRM_CAT_PAIR_ID</code>. We also define the sampling groups. As before, we set them to correspond to the transmission groups even if we are only interested in the flows within and between groups “1” and “2”. After the model is fitted, we will aggregate the output to the flows between groups “1” and “2”.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">dobs[, TR_SAMPLING_CATEGORY<span class="op">:</span><span class="er">=</span>TR_TRM_CATEGORY]</a>
<a class="sourceLine" id="cb18-2" title="2">dobs[, REC_SAMPLING_CATEGORY<span class="op">:</span><span class="er">=</span>REC_TRM_CATEGORY]</a>
<a class="sourceLine" id="cb18-3" title="3"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setkey.html">setkey</a></span>(dobs,TR_TRM_CATEGORY,REC_TRM_CATEGORY)</a>
<a class="sourceLine" id="cb18-4" title="4">dobs[, TRM_CAT_PAIR_ID<span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(dobs))]</a>
<a class="sourceLine" id="cb18-5" title="5">dobs[, S<span class="op">:</span><span class="er">=</span><span class="ot">NULL</span>]</a>
<a class="sourceLine" id="cb18-6" title="6">dobs</a></code></pre></div>
<pre><code>##    REC_TRM_CATEGORY TR_TRM_CATEGORY TRM_CAT_PAIR_ID TRM_OBS
## 1:              1:M             1:F               1      55
## 2:              2:M             1:F               2       7
## 3:              1:F             1:M               3      77
## 4:              2:F             1:M               4      22
## 5:              1:M             2:F               5      17
## 6:              2:M             2:F               6      35
## 7:              1:F             2:M               7      28
## 8:              2:F             2:M               8      56
##    TR_SAMPLING_CATEGORY REC_SAMPLING_CATEGORY
## 1:                  1:F                   1:M
## 2:                  1:F                   2:M
## 3:                  1:M                   1:F
## 4:                  1:M                   2:F
## 5:                  2:F                   1:M
## 6:                  2:F                   2:M
## 7:                  2:M                   1:F
## 8:                  2:M                   2:F</code></pre>
<p><strong>We also need to define the prior distribution on the unknown sampling probabilities, and generate samples from it</strong>. This final step is where the GLM approach differs from the SARWS approach. For the 4 groups <span class="math display">\[
a= 1F, 1M, 2F, 2M
\]</span> we model the sampling probability by <span class="math display">\[
X_a^i\sim Binom(X_a^i, \xi_a)
\]</span> using the same notation as above, and where <span class="math display">\[
\mbox{logit}(\xi_{a})=\beta_0+\beta_1 * G_a + \beta_2 S_{a}
\]</span> where <span class="math inline">\(G_a\)</span> equals 0 if the population group is “1”, and 1 if the population group is “2”, <span class="math inline">\(S_a\)</span> equals 0 if gender is female and 1 if gender is male, and the priors on the regression coefficients are quite vague, <span class="math display">\[
\beta_0\sim N(0,100), \beta_1\sim N(0,10), \beta_2\sim N(0,10).
\]</span> Next we infer the posterior distribution of sampling probabilities with <code>stan</code>. The code for the above GLM regression model is as follows:</p>
<pre><code>data{
    int&lt;lower=1&gt; N;
    int SUC[N];
    int TRIAL[N];
    int GROUP[N];
    int MALE[N];
}
parameters{
    real a;
    real grouptwo;
    real male;
}
model{
    vector[N] p_suc;
    male ~ normal( 0 , 10 );
    grouptwo ~ normal( 0 , 10 );
    a ~ normal( 0 , 100 );
    for ( i in 1:N ) {
        p_suc[i] = a + grouptwo * GROUP[i] + male * MALE[i];
    }
    SUC ~ binomial_logit( TRIAL , p_suc );
}</code></pre>
<p>Let us fit the model to the sampling data, get samples from the posterior distributions, and calculate their log-density values:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(rstan)</a></code></pre></div>
<pre><code>## Loading required package: ggplot2</code></pre>
<pre><code>## Loading required package: StanHeaders</code></pre>
<pre><code>## rstan (Version 2.18.2, GitRev: 2e1f913d3ca3)</code></pre>
<pre><code>## For execution on a local, multicore CPU with excess RAM we recommend calling
## options(mc.cores = parallel::detectCores()).
## To avoid recompilation of unchanged Stan programs, we recommend calling
## rstan_options(auto_write = TRUE)</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1">nprior &lt;-<span class="st"> </span><span class="fl">1e3</span></a>
<a class="sourceLine" id="cb26-2" title="2">infile.sampling.stan.model &lt;-<span class="st"> 'glm_sex2comm2.stan'</span> <span class="co">#in vignettes/glm_sex2comm2.stan</span></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="co">#   run STAN </span></a>
<a class="sourceLine" id="cb26-4" title="4">tmp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/subset.data.table.html">subset</a></span>(ds,<span class="dt">select=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'SEX'</span>,<span class="st">'GROUP'</span>,<span class="st">'TRIAL'</span>,<span class="st">'SUC'</span>))</a>
<a class="sourceLine" id="cb26-5" title="5">tmp[, GROUP<span class="op">:</span><span class="er">=</span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(GROUP<span class="op">==</span><span class="dv">2</span>)]</a>
<a class="sourceLine" id="cb26-6" title="6">tmp[, MALE<span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(SEX<span class="op">==</span><span class="st">'M'</span>)]</a>
<a class="sourceLine" id="cb26-7" title="7">tmp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(tmp)</a>
<a class="sourceLine" id="cb26-8" title="8">tmp<span class="op">$</span>N &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(ds)</a>
<a class="sourceLine" id="cb26-9" title="9">fit.par &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/rstan/man/stan.html">stan</a></span>(  <span class="dt">file =</span> infile.sampling.stan.model, </a>
<a class="sourceLine" id="cb26-10" title="10">                  <span class="dt">data =</span> tmp, </a>
<a class="sourceLine" id="cb26-11" title="11">                  <span class="dt">iter =</span> <span class="fl">2e3</span>,</a>
<a class="sourceLine" id="cb26-12" title="12">                  <span class="dt">warmup =</span> <span class="fl">5e2</span>,</a>
<a class="sourceLine" id="cb26-13" title="13">                  <span class="dt">cores =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb26-14" title="14">                  <span class="dt">chains =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb26-15" title="15">                  <span class="dt">init =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">a=</span><span class="dv">0</span>, <span class="dt">grouptwo=</span><span class="dv">0</span>, <span class="dt">male=</span><span class="dv">0</span>)))</a></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL 'glm_sex2comm2' NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 2.5e-05 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.25 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
## Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
## Chain 1: Iteration:  501 / 2000 [ 25%]  (Sampling)
## Chain 1: Iteration:  700 / 2000 [ 35%]  (Sampling)
## Chain 1: Iteration:  900 / 2000 [ 45%]  (Sampling)
## Chain 1: Iteration: 1100 / 2000 [ 55%]  (Sampling)
## Chain 1: Iteration: 1300 / 2000 [ 65%]  (Sampling)
## Chain 1: Iteration: 1500 / 2000 [ 75%]  (Sampling)
## Chain 1: Iteration: 1700 / 2000 [ 85%]  (Sampling)
## Chain 1: Iteration: 1900 / 2000 [ 95%]  (Sampling)
## Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 0.028743 seconds (Warm-up)
## Chain 1:                0.06264 seconds (Sampling)
## Chain 1:                0.091383 seconds (Total)
## Chain 1:</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1"><span class="co"># extract samples from the prior distribution</span></a>
<a class="sourceLine" id="cb28-2" title="2">fit.e &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/rstan/man/stanfit-method-extract.html">extract</a></span>(fit.par)</a>
<a class="sourceLine" id="cb28-3" title="3">tmp &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(fit.e<span class="op">$</span>a), nprior)</a>
<a class="sourceLine" id="cb28-4" title="4">ds[, GROUP<span class="op">:</span><span class="er">=</span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(GROUP<span class="op">==</span><span class="dv">2</span>)]</a>
<a class="sourceLine" id="cb28-5" title="5">ds[, MALE<span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(SEX<span class="op">==</span><span class="st">'M'</span>)]</a>
<a class="sourceLine" id="cb28-6" title="6">dprior &lt;-<span class="st"> </span>ds[,  </a>
<a class="sourceLine" id="cb28-7" title="7">               {</a>
<a class="sourceLine" id="cb28-8" title="8">                  z&lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/with.html">with</a></span>(fit.e, a <span class="op">+</span><span class="st"> </span>grouptwo <span class="op">*</span><span class="st"> </span>GROUP <span class="op">+</span><span class="st"> </span>male <span class="op">*</span><span class="st"> </span>MALE)</a>
<a class="sourceLine" id="cb28-9" title="9">                  <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">SAMPLE=</span><span class="dv">1</span><span class="op">:</span>nprior, <span class="dt">ETA=</span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(z[tmp]))</a>
<a class="sourceLine" id="cb28-10" title="10">               },   </a>
<a class="sourceLine" id="cb28-11" title="11">               by=<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'CATEGORY'</span>)]</a>
<a class="sourceLine" id="cb28-12" title="12">dprior[, P<span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(ETA)<span class="op">/</span>(<span class="dv">1</span><span class="op">+</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(ETA))]</a>
<a class="sourceLine" id="cb28-13" title="13"></a>
<a class="sourceLine" id="cb28-14" title="14"><span class="co"># calculate log density using the betakernal bounded density estimator</span></a>
<a class="sourceLine" id="cb28-15" title="15"><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span>(bde)</a></code></pre></div>
<pre><code>## Loading required package: bde</code></pre>
<pre><code>## Loading required package: shiny</code></pre>
<pre><code>## 
## Attaching package: 'bde'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     density, quantile</code></pre>
<pre><code>## The following object is masked from 'package:methods':
## 
##     getSubclasses</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1">tmp &lt;-<span class="st"> </span>dprior[, </a>
<a class="sourceLine" id="cb34-2" title="2">        {</a>
<a class="sourceLine" id="cb34-3" title="3">            bdest&lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/bde/man/bde.html">bde</a></span>( P, </a>
<a class="sourceLine" id="cb34-4" title="4">                         <span class="dt">dataPointsCache=</span><span class="kw"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(P), </a>
<a class="sourceLine" id="cb34-5" title="5">                         <span class="dt">b=</span><span class="fl">0.001</span>, </a>
<a class="sourceLine" id="cb34-6" title="6">                         <span class="dt">estimator=</span><span class="st">'betakernel'</span>, </a>
<a class="sourceLine" id="cb34-7" title="7">                         <span class="dt">lower.limit=</span><span class="dv">0</span>, </a>
<a class="sourceLine" id="cb34-8" title="8">                         <span class="dt">upper.limit=</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb34-9" title="9">                         <span class="dt">options =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>( <span class="dt">modified=</span><span class="ot">FALSE</span>, </a>
<a class="sourceLine" id="cb34-10" title="10">                                         <span class="dt">normalization=</span><span class="st">'densitywise'</span>, </a>
<a class="sourceLine" id="cb34-11" title="11">                                         <span class="dt">mbc=</span><span class="st">'none'</span>, </a>
<a class="sourceLine" id="cb34-12" title="12">                                         <span class="dt">c=</span><span class="fl">0.5</span>))</a>
<a class="sourceLine" id="cb34-13" title="13">            <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">SAMPLE=</span>SAMPLE, <span class="dt">LP=</span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/bde/man/density.html">density</a></span>(bdest, P)))</a>
<a class="sourceLine" id="cb34-14" title="14">         }, </a>
<a class="sourceLine" id="cb34-15" title="15">         by=<span class="st">'CATEGORY'</span>]</a>
<a class="sourceLine" id="cb34-16" title="16">dprior &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/merge.html">merge</a></span>(dprior, tmp, <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'CATEGORY'</span>,<span class="st">'SAMPLE'</span>))</a>
<a class="sourceLine" id="cb34-17" title="17"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/assign.html">set</a></span>(dprior, <span class="ot">NULL</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'ETA'</span>), <span class="ot">NULL</span>)   </a>
<a class="sourceLine" id="cb34-18" title="18"><span class="kw"><a href="https://rdrr.io/pkg/data.table/man/setattr.html">setnames</a></span>(dprior, <span class="st">'CATEGORY'</span>, <span class="st">'SAMPLING_CATEGORY'</span>)</a>
<a class="sourceLine" id="cb34-19" title="19"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(dprior)</a></code></pre></div>
<pre><code>##    SAMPLING_CATEGORY SAMPLE         P       LP
## 1:               1:F      1 0.8137537 2.734744
## 2:               1:F      2 0.8306980 2.764320
## 3:               1:F      3 0.8358517 2.672081
## 4:               1:F      4 0.8509679 2.052766
## 5:               1:F      5 0.8329906 2.729831
## 6:               1:F      6 0.8468722 2.277597</code></pre>
<p>This data set can be loaded through</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(fourGroupFlows1)</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#data-set-1-simple-sarws">Data set 1 (simple, SARWS)</a></li>
      <li><a href="#corresponding-phyloflows-input-data-simple-sarws">Corresponding <strong>phyloflows</strong> input data (simple, SARWS)</a></li>
      <li><a href="#data-set-2-more-complex-glm">Data set 2 (more complex, GLM)</a></li>
      <li><a href="#corresponding-phyloflows-input-data-more-complex-glm">Corresponding <strong>phyloflows</strong> input data (more complex, GLM)</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Xiaoyue Xi, Oliver Ratmann.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9000.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
