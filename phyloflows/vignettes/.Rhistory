cat('\nUpdate IDs with lowest acceptance rates')
print( da[order(ACC_RATE)[1:10],] )
# remove burn-in
cat('\nRemoving burnin in set to ', 100*control$burnin.p,'% of chain, total iterations=',burnin.n)
tmp	<- seq.int(burnin.n+1L,nrow(mc$pars$S))
pars	<- pars[tmp,,drop=FALSE]
# effective sampling sizes
cat('\nCalculating effective sample size for all parameters...')
tmp	<- mcmc(pars)
ans	<- data.table(ID= seq_len(ncol(pars)), VAR= colnames(pars), NEFF=as.numeric(effectiveSize(tmp)))
set(ans, NULL, 'ID', ans[, factor(ID, labels=VAR)])
if(control$pdf.plot.all.parameters)
{
ggplot(ans, aes(x=NEFF, y=ID)) +
geom_point() +
theme_bw() +
labs(x='\neffective sample size', y='')
ggsave(file=paste0(control$outfile.base,'_neff.pdf'), w=6, h=control$pdf.height.per.par*ncol(pars)*0.15, limitsize=FALSE)
}
# summarise mean, sd, quantiles
cat('\nCalculating posterior summaries for all parameters...')
tmp	<- apply(pars, 2, function(x) quantile(x, p=c((1-control$credibility.interval)/2, 0.5, control$credibility.interval+(1-control$credibility.interval)/2)))
tmp	<- data.table(	VAR= colnames(pars),
MEAN= apply(pars, 2, mean),
SD= apply(pars, 2, sd),
MEDIAN=tmp[2,],
CI_L=tmp[1,],
CI_U=tmp[3,])
ans	<- merge(tmp, ans, by='VAR')
cat('\nParameters with lowest effective samples')
print( ans[order(NEFF)[1:10],] )
# write to file
cat('\nWriting summary file to',paste0(control$outfile.base,'_summary.csv'))
setkey(ans, ID)
write.csv(ans, file=paste0(control$outfile.base,'_summary.csv'))
worst.pars	<- pars[, ans[order(NEFF)[1:pdf.plot.n.worst.case.parameters], VAR]]
order(NEFF)[1:pdf.plot.n.worst.case.parameters]
ans[order(NEFF)[1:pdf.plot.n.worst.case.parameters], VAR]
ans
cat('\nReading aggregated MCMC output...')
pars		<- as.data.table(read.csv(infile, stringsAsFactors=FALSE))
pars		<- subset(pars, VARIABLE=='PI')
infile<-mcmc.file
cat('\nReading aggregated MCMC output...')
pars		<- as.data.table(read.csv(infile, stringsAsFactors=FALSE))
pars		<- subset(pars, VARIABLE=='PI')
mc$pars$PI
dobs[,LBD:=rnorm(nrow(dobs),2,0.2)]
DO===dobs
dobs
library(data.table)
library(gtools)
# library(phyloflows)
set.seed(42)
num.inf.1<-2000
num.inf.2<-2500
ds<-data.table(COMM_NUM_B=c(rep(1,num.inf.1),rep(2,num.inf.2)),INF=rep(1,num.inf.1+num.inf.2))
num.f.1<-round(num.inf.1*0.7)
num.m.1<-num.inf.1-round(num.inf.1*0.7)
num.f.2<-round(num.inf.2*0.6)
num.m.2<-num.inf.2-round(num.inf.2*0.6)
ds$SEX<-c(rep('F',num.f.1),
rep('M',num.m.1),
rep('F',num.f.2),
rep('M',num.m.2))
ds$AGE_AT_MID_C<-c(rep('15-24',round(num.f.1*0.25)),
rep('25-34',round(num.f.1*0.6)),
rep('35+',num.f.1-round(num.f.1*0.25)-round(num.f.1*0.6)),
rep('15-24',round(num.m.1*0.2)),
rep('25-34',round(num.m.1*0.5)),
rep('35+',num.m.1-round(num.m.1*0.2)-round(num.m.1*0.5)),
rep('15-24',round(num.f.2*0.25)),
rep('25-34',round(num.f.2*0.5)),
rep('35+',num.f.2-round(num.f.2*0.25)-round(num.f.2*0.5)),
rep('15-24',round(num.m.2*0.2)),
rep('25-34',round(num.m.2*0.4)),
rep('35+',num.m.2-round(num.m.2*0.2)-round(num.m.2*0.4))
)
ds		<- ds[, list(TRIAL=length(INF)),by=c('AGE_AT_MID_C','SEX','COMM_NUM_B')]
comm<-c(0.5,-0.5)
a<-0.4
male<-0.4
young<-0.3
midage<-0.2
ds[, AGE1:= as.integer(AGE_AT_MID_C=='15-24')]
ds[, AGE2:= as.integer(AGE_AT_MID_C=='25-34')]
ds[, MALE:= as.integer(SEX=='M')]
ds[,LOGIT_P_SEQ:=a + comm[COMM_NUM_B] + male*MALE + young*AGE1 + midage*AGE2]
ds[,P_SEQ:=exp(LOGIT_P_SEQ)/(1+exp(LOGIT_P_SEQ))]
ds[,SUC:=rbinom(nrow(ds),TRIAL,P_SEQ)]
ds[,CATEGORY:=paste0(COMM_NUM_B,':',SEX,':',AGE_AT_MID_C)]
ds[,COMM_NUM_B:=as.integer(COMM_NUM_B)]
dobs<-as.data.table(expand.grid(TR_CATEGORY=ds$CATEGORY,REC_CATEGORY=ds$CATEGORY))
dobs[, c("TR_COMM_NUM_B","TR_SEX", "TR_AGE_AT_MID_C") := tstrsplit(TR_CATEGORY, ":", fixed=TRUE)]
dobs[, c("REC_COMM_NUM_B","REC_SEX", "REC_AGE_AT_MID_C") := tstrsplit(REC_CATEGORY, ":", fixed=TRUE)]
dobs<-dobs[TR_SEX!=REC_SEX,]
dobs
dobs[,LBD:=rnorm(nrow(dobs),2,0.2)]
dobs[TR_CATEGORY!=REC_CATEGORY,LBD]<-rnorm(nrow(dobs[TR_CATEGORY!=REC_CATEGORY,]),1,0.2)
dobs[TR_CATEGORY!=REC_CATEGORY,LBD]
nrow(dobs[TR_CATEGORY!=REC_CATEGORY,])
dobs[,LBD:=rnorm(nrow(dobs),2,0.2)]
dobs
rnorm(length(dobs[TR_COMM_NUM_B!=REC_COMM_NUM_B,LBD]),1,0.2)
lbd   <- rnorm(nrow(dobs),2,0.2)
tmp   <- dobs[TR_COMM_NUM_B!=REC_COMM_NUM_B,TR_TRM_PAIR_ID]
dobs<-as.data.table(expand.grid(TR_CATEGORY=ds$CATEGORY,REC_CATEGORY=ds$CATEGORY))
dobs[, c("TR_COMM_NUM_B","TR_SEX", "TR_AGE_AT_MID_C") := tstrsplit(TR_CATEGORY, ":", fixed=TRUE)]
dobs[, c("REC_COMM_NUM_B","REC_SEX", "REC_AGE_AT_MID_C") := tstrsplit(REC_CATEGORY, ":", fixed=TRUE)]
dobs<-dobs[TR_SEX!=REC_SEX,]
dobs[,TRM_CAT_PAIR_ID:=seq_len(nrow(dobs))]
lbd   <- rnorm(nrow(dobs),2,0.2)
tmp   <- dobs[TR_COMM_NUM_B!=REC_COMM_NUM_B,TR_TRM_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
dobs
dobs[TR_COMM_NUM_B!=REC_COMM_NUM_B,TR_TRM_PAIR_ID]
dobs[TR_COMM_NUM_B!=REC_COMM_NUM_B,]
lbd   <- rnorm(nrow(dobs),2,0.2)
tmp   <- dobs[TR_COMM_NUM_B!=REC_COMM_NUM_B,TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
tmp
lbd   <- rnorm(nrow(dobs),2,0.2)
tmp   <- dobs[TR_COMM_NUM_B!=REC_COMM_NUM_B,TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
tmp   <- dobs[TR_COMM_NUM_B==REC_COMM_NUM_B & TR_SEX=='M' &
( (TR_AGE_AT_MID_C=='15-24' & REC_AGE_AT_MID_C=='25-34')|
(TR_AGE_AT_MID_C=='25-34' & REC_AGE_AT_MID_C=='35+')|
(TR_AGE_AT_MID_C=='15-24' & REC_AGE_AT_MID_C=='35+') ),TRM_CAT_PAIR_ID]
tmp
lbd   <- rnorm(nrow(dobs),2,0.2)
tmp   <- dobs[TR_COMM_NUM_B!=REC_COMM_NUM_B,TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
tmp   <- dobs[TR_COMM_NUM_B==REC_COMM_NUM_B & TR_SEX=='M' &
( (TR_AGE_AT_MID_C=='15-24' & REC_AGE_AT_MID_C=='25-34')|
(TR_AGE_AT_MID_C=='25-34' & REC_AGE_AT_MID_C=='35+')|
(TR_AGE_AT_MID_C=='15-24' & REC_AGE_AT_MID_C=='35+') ),TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
tmp   <- dobs[TR_COMM_NUM_B==REC_COMM_NUM_B & TR_SEX=='F' &
( (TR_AGE_AT_MID_C=='25-34' & REC_AGE_AT_MID_C=='15-24')|
(TR_AGE_AT_MID_C=='35+' & REC_AGE_AT_MID_C=='15-24')|
(TR_AGE_AT_MID_C=='35+' & REC_AGE_AT_MID_C=='25-34') ),TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
lbd
nrow(ds)
ds
length(unique(ds$COMM_NUM_B))
library(data.table)
library(gtools)
# library(phyloflows)
set.seed(42)
num.inf.1<-2000
num.inf.2<-2500
ds<-data.table(COMM_NUM_B=c(rep(1,num.inf.1),rep(2,num.inf.2)),INF=rep(1,num.inf.1+num.inf.2))
num.f.1<-round(num.inf.1*0.7)
num.m.1<-num.inf.1-round(num.inf.1*0.7)
num.f.2<-round(num.inf.2*0.6)
num.m.2<-num.inf.2-round(num.inf.2*0.6)
ds$SEX<-c(rep('F',num.f.1),
rep('M',num.m.1),
rep('F',num.f.2),
rep('M',num.m.2))
ds$AGE_AT_MID_C<-c(rep('15-24',round(num.f.1*0.25)),
rep('25-34',round(num.f.1*0.6)),
rep('35+',num.f.1-round(num.f.1*0.25)-round(num.f.1*0.6)),
rep('15-24',round(num.m.1*0.2)),
rep('25-34',round(num.m.1*0.5)),
rep('35+',num.m.1-round(num.m.1*0.2)-round(num.m.1*0.5)),
rep('15-24',round(num.f.2*0.25)),
rep('25-34',round(num.f.2*0.5)),
rep('35+',num.f.2-round(num.f.2*0.25)-round(num.f.2*0.5)),
rep('15-24',round(num.m.2*0.2)),
rep('25-34',round(num.m.2*0.4)),
rep('35+',num.m.2-round(num.m.2*0.2)-round(num.m.2*0.4))
)
ds		<- ds[, list(TRIAL=length(INF)),by=c('AGE_AT_MID_C','SEX','COMM_NUM_B')]
comm<-c(0.5,-0.5)
a<-0.4
male<-0.4
young<-0.3
midage<-0.2
ds[, AGE1:= as.integer(AGE_AT_MID_C=='15-24')]
ds[, AGE2:= as.integer(AGE_AT_MID_C=='25-34')]
ds[, MALE:= as.integer(SEX=='M')]
ds[,LOGIT_P_SEQ:=a + comm[COMM_NUM_B] + male*MALE + young*AGE1 + midage*AGE2]
ds[,P_SEQ:=exp(LOGIT_P_SEQ)/(1+exp(LOGIT_P_SEQ))]
ds[,SUC:=rbinom(nrow(ds),TRIAL,P_SEQ)]
ds[,CATEGORY:=paste0(COMM_NUM_B,':',SEX,':',AGE_AT_MID_C)]
ds[,COMM_NUM_B:=as.integer(COMM_NUM_B)]
dobs<-as.data.table(expand.grid(TR_CATEGORY=ds$CATEGORY,REC_CATEGORY=ds$CATEGORY))
dobs[, c("TR_COMM_NUM_B","TR_SEX", "TR_AGE_AT_MID_C") := tstrsplit(TR_CATEGORY, ":", fixed=TRUE)]
dobs[, c("REC_COMM_NUM_B","REC_SEX", "REC_AGE_AT_MID_C") := tstrsplit(REC_CATEGORY, ":", fixed=TRUE)]
dobs<-dobs[TR_SEX!=REC_SEX,]
dobs[,TRM_CAT_PAIR_ID:=seq_len(nrow(dobs))]
lbd   <- rnorm(nrow(dobs),2,0.2)
tmp   <- dobs[TR_COMM_NUM_B!=REC_COMM_NUM_B,TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
tmp   <- dobs[TR_COMM_NUM_B==REC_COMM_NUM_B & TR_SEX=='M' &
( (TR_AGE_AT_MID_C=='15-24' & REC_AGE_AT_MID_C=='25-34')|
(TR_AGE_AT_MID_C=='25-34' & REC_AGE_AT_MID_C=='35+')|
(TR_AGE_AT_MID_C=='15-24' & REC_AGE_AT_MID_C=='35+') ),TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
tmp   <- dobs[TR_COMM_NUM_B==REC_COMM_NUM_B & TR_SEX=='F' &
( (TR_AGE_AT_MID_C=='25-34' & REC_AGE_AT_MID_C=='15-24')|
(TR_AGE_AT_MID_C=='35+' & REC_AGE_AT_MID_C=='15-24')|
(TR_AGE_AT_MID_C=='35+' & REC_AGE_AT_MID_C=='25-34') ),TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
TRUE_PI<-lbd/sum(lbd)
dobs[,TRUE_PI:=as.vector(TRUE_PI)]
tmp<-subset(ds,select=c('CATEGORY','P_SEQ'))
setnames(tmp,colnames(tmp),paste0('TR_',colnames(tmp)))
dobs<-merge(dobs,tmp,by='TR_CATEGORY')
setnames(tmp,colnames(tmp),gsub('TR_','REC_',colnames(tmp)))
dobs<-merge(dobs,tmp,by='REC_CATEGORY')
dobs[,S:=TR_P_SEQ*REC_P_SEQ]
N<-rpois(1,300/mean(dobs$S))
z<-rmultinom(1,size=N,prob=TRUE_PI)
n<-matrix(NA_integer_,ncol=1,nrow=length(TRUE_PI))
for (i in 1:length(TRUE_PI)){
n[i]<-rbinom(1,size=z[i],dobs$S[i])
}
dobs[, TRM_OBS:= n]
dobs.obs.zero<-which(dobs$TRM_OBS==0)
dobs<-dobs[TRM_OBS!=0,]
dobs[, TRM_CAT_PAIR_ID:= seq_len(nrow(dobs))]
# remove irrelevant terms
set(ds,NULL,c('P_SEQ','LOGIT_P_SEQ'),NULL)
set(dobs,NULL,c('TR_P_SEQ','REC_P_SEQ','S','TRUE_PI'),NULL)
dobs[,TR_COMM_NUM_B:=as.integer(TR_COMM_NUM_B)]
dobs[,REC_COMM_NUM_B:=as.integer(REC_COMM_NUM_B)]
library(rstan)
library(bayesplot)
infile.sequencing.stan.model<-'glm_age3sex2comm2bin.stan'
#	run STAN
tmp			<- as.list(subset(ds,select=c('COMM_NUM_B','TRIAL','SUC','MALE','AGE1','AGE2')))
tmp$N		<- nrow(ds)
tmp$N_COMM	<- length(unique(ds$COMM_NUM_B))
fit.par 	<- stan(	file = infile.sequencing.stan.model,
data = tmp,
iter = 10e3,
warmup = 5e2,
cores = 1,
chains = 1,
init = list(list(a=0, comm=rep(0,2), sig_comm=1, male=0, age1=0, age2=0)))
fit.pars	<- c('a','comm','sig_comm','male','age1','age2')
any(rhat(fit.par, pars=fit.pars)>1.02)
any(neff_ratio(fit.par, pars=fit.pars) * 9.5e3 < 500)
po              <- as.matrix(fit.par)
po
po              <- po[, colnames(po)[!grepl('p_suc|lp__',colnames(po))]]
po
p   <- mcmc_trace(po, pars=colnames(po), facet_args = list(ncol = 1))
pdf(file=paste0(outfile.base,'190327_participation_model_marginaltraces.pdf'), w=7, h=100)
p
dev.off()
p   <- mcmc_trace(po, pars=colnames(po), facet_args = list(ncol = 1))
pdf(file='190327_participation_model_marginaltraces.pdf', w=7, h=100)
p
dev.off()
fit.e		<- extract(fit.par)
set.seed(42)
tmp			<- sample(length(fit.e$a), nprior)
nprior  <- 1000
fit.e		<- extract(fit.par)
set.seed(42)
tmp			<- sample(length(fit.e$a), nprior)
DPS
dps
nprior  <- 1000
fit.e		<- extract(fit.par)
set.seed(42)
tmp			<- sample(length(fit.e$a), nprior)
nprior  <- 1000
set.seed(42)
dps   <- data.table(CATEGORY=unique(c(dobs$TR_CATEGORY,dobs$REC_CATEGORY)))
dps
dps[, COMM_NUM_B:= dps[, gsub('^(.+)\\:(.)\\:(.+)\\:(.)$','\\1',CATEGORY)]]
dps[, SEX:= dps[,gsub('^(.+)\\:(.)\\:(.+)\\:(.)$','\\2',CATEGORY)]]
dps[, AGE_AT_MID_C:= dps[, gsub('^(.+)\\:(.)\\:(.+)\\:(.)$','\\3',CATEGORY)]]
dps[, AGE_YOUNG:= as.integer(AGE_AT_MID_C=='15-24')]
dps[, AGE_MID:= as.integer(AGE_AT_MID_C=='25-34')]
dps[, MALE:= as.integer(SEX=='M')]
dps
dps   <- data.table(CATEGORY=unique(c(dobs$TR_CATEGORY,dobs$REC_CATEGORY)))
dps[, COMM_NUM_B:= dps[, gsub('^(.+)\\:(.)\\:(.+)$','\\1',CATEGORY)]]
dps[, SEX:= dps[,gsub('^(.+)\\:(.)\\:(.+)','\\2',CATEGORY)]]
dps[, AGE_AT_MID_C:= dps[, gsub('^(.+)\\:(.)\\:(.+)$','\\3',CATEGORY)]]
dps
dps[, AGE_YOUNG:= as.integer(AGE_AT_MID_C=='15-24')]
dps[, AGE_MID:= as.integer(AGE_AT_MID_C=='25-34')]
dps[, MALE:= as.integer(SEX=='M')]
tmp
length(fit.e$a)
dps			<- dps[,
{
z<- with(fit.e, a + comm[,COMM_NUM_B] + male * MALE +
age1 * AGE1 + age2 * AGE2)
list(SAMPLE=1:nprior, ETA=as.numeric(z[tmp]))
},
by=c('CATEGORY')]
dps$COMM_NUM_B
dps[, COMM_NUM_B:=as.integer(COMM_NUM_B)]
fit.e		<- extract(fit.par)
tmp			<- sample(length(fit.e$a), nprior)
dps			<- dps[,
{
z<- with(fit.e, a + comm[,COMM_NUM_B] + male * MALE +
age1 * AGE1 + age2 * AGE2)
list(SAMPLE=1:nprior, ETA=as.numeric(z[tmp]))
},
by=c('CATEGORY')]
dps
nprior  <- 1000
set.seed(42)
dps   <- data.table(CATEGORY=unique(c(dobs$TR_CATEGORY,dobs$REC_CATEGORY)))
dps[, COMM_NUM_B:= dps[, gsub('^(.+)\\:(.)\\:(.+)$','\\1',CATEGORY)]]
dps[, SEX:= dps[,gsub('^(.+)\\:(.)\\:(.+)','\\2',CATEGORY)]]
dps[, AGE_AT_MID_C:= dps[, gsub('^(.+)\\:(.)\\:(.+)$','\\3',CATEGORY)]]
dps[, AGE1:= as.integer(AGE_AT_MID_C=='15-24')]
dps[, AGE2:= as.integer(AGE_AT_MID_C=='25-34')]
dps[, MALE:= as.integer(SEX=='M')]
dps[, COMM_NUM_B:=as.integer(COMM_NUM_B)]
dps
fit.e		<- extract(fit.par)
tmp			<- sample(length(fit.e$a), nprior)
dps			<- dps[,
{
z<- with(fit.e, a + comm[,COMM_NUM_B] + male * MALE +
age1 * AGE1 + age2 * AGE2)
list(SAMPLE=1:nprior, ETA=as.numeric(z[tmp]))
},
by=c('CATEGORY')]
dps
dps[, P:= exp(ETA)/(1+exp(ETA))]
dps
nprior  <- 1000
set.seed(42)
dprior   <- data.table(CATEGORY=unique(c(dobs$TR_TRM_CATEGORY,dobs$REC_TRM_CATEGORY)))
dprior[, COMM_NUM_B:= dprior[, gsub('^(.+)\\:(.)\\:(.+)$','\\1',CATEGORY)]]
dprior[, SEX:= dprior[,gsub('^(.+)\\:(.)\\:(.+)','\\2',CATEGORY)]]
dprior[, AGE_AT_MID_C:= dprior[, gsub('^(.+)\\:(.)\\:(.+)$','\\3',CATEGORY)]]
dprior[, AGE1:= as.integer(AGE_AT_MID_C=='15-24')]
dprior[, AGE2:= as.integer(AGE_AT_MID_C=='25-34')]
dprior[, MALE:= as.integer(SEX=='M')]
dprior[, COMM_NUM_B:=as.integer(COMM_NUM_B)]
library(data.table)
library(gtools)
# library(phyloflows)
set.seed(42)
num.inf.1<-2000
num.inf.2<-2500
ds<-data.table(COMM_NUM_B=c(rep(1,num.inf.1),rep(2,num.inf.2)),INF=rep(1,num.inf.1+num.inf.2))
num.f.1<-round(num.inf.1*0.7)
num.m.1<-num.inf.1-round(num.inf.1*0.7)
num.f.2<-round(num.inf.2*0.6)
num.m.2<-num.inf.2-round(num.inf.2*0.6)
ds$SEX<-c(rep('F',num.f.1),
rep('M',num.m.1),
rep('F',num.f.2),
rep('M',num.m.2))
ds$AGE_AT_MID_C<-c(rep('15-24',round(num.f.1*0.25)),
rep('25-34',round(num.f.1*0.6)),
rep('35+',num.f.1-round(num.f.1*0.25)-round(num.f.1*0.6)),
rep('15-24',round(num.m.1*0.2)),
rep('25-34',round(num.m.1*0.5)),
rep('35+',num.m.1-round(num.m.1*0.2)-round(num.m.1*0.5)),
rep('15-24',round(num.f.2*0.25)),
rep('25-34',round(num.f.2*0.5)),
rep('35+',num.f.2-round(num.f.2*0.25)-round(num.f.2*0.5)),
rep('15-24',round(num.m.2*0.2)),
rep('25-34',round(num.m.2*0.4)),
rep('35+',num.m.2-round(num.m.2*0.2)-round(num.m.2*0.4))
)
ds		<- ds[, list(TRIAL=length(INF)),by=c('AGE_AT_MID_C','SEX','COMM_NUM_B')]
comm<-c(0.5,-0.5)
a<-0.4
male<-0.4
young<-0.3
midage<-0.2
ds[, AGE1:= as.integer(AGE_AT_MID_C=='15-24')]
ds[, AGE2:= as.integer(AGE_AT_MID_C=='25-34')]
ds[, MALE:= as.integer(SEX=='M')]
ds[,LOGIT_P_SEQ:=a + comm[COMM_NUM_B] + male*MALE + young*AGE1 + midage*AGE2]
ds[,P_SEQ:=exp(LOGIT_P_SEQ)/(1+exp(LOGIT_P_SEQ))]
ds[,SUC:=rbinom(nrow(ds),TRIAL,P_SEQ)]
ds[,CATEGORY:=paste0(COMM_NUM_B,':',SEX,':',AGE_AT_MID_C)]
ds[,COMM_NUM_B:=as.integer(COMM_NUM_B)]
dobs<-as.data.table(expand.grid(TR_TRM_CATEGORY=ds$CATEGORY,REC_TRM_CATEGORY=ds$CATEGORY))
dobs[, c("TR_COMM_NUM_B","TR_SEX", "TR_AGE_AT_MID_C") := tstrsplit(TR_TRM_CATEGORY, ":", fixed=TRUE)]
dobs[, c("REC_COMM_NUM_B","REC_SEX", "REC_AGE_AT_MID_C") := tstrsplit(REC_TRM_CATEGORY, ":", fixed=TRUE)]
dobs<-dobs[TR_SEX!=REC_SEX,]
dobs[,TRM_CAT_PAIR_ID:=seq_len(nrow(dobs))]
lbd   <- rnorm(nrow(dobs),2,0.2)
tmp   <- dobs[TR_COMM_NUM_B!=REC_COMM_NUM_B,TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
tmp   <- dobs[TR_COMM_NUM_B==REC_COMM_NUM_B & TR_SEX=='M' &
( (TR_AGE_AT_MID_C=='15-24' & REC_AGE_AT_MID_C=='25-34')|
(TR_AGE_AT_MID_C=='25-34' & REC_AGE_AT_MID_C=='35+')|
(TR_AGE_AT_MID_C=='15-24' & REC_AGE_AT_MID_C=='35+') ),TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
tmp   <- dobs[TR_COMM_NUM_B==REC_COMM_NUM_B & TR_SEX=='F' &
( (TR_AGE_AT_MID_C=='25-34' & REC_AGE_AT_MID_C=='15-24')|
(TR_AGE_AT_MID_C=='35+' & REC_AGE_AT_MID_C=='15-24')|
(TR_AGE_AT_MID_C=='35+' & REC_AGE_AT_MID_C=='25-34') ),TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
TRUE_PI<-lbd/sum(lbd)
dobs[,TRUE_PI:=as.vector(TRUE_PI)]
tmp<-subset(ds,select=c('CATEGORY','P_SEQ'))
setnames(tmp,colnames(tmp),paste0('TR_TRM_',colnames(tmp)))
dobs<-merge(dobs,tmp,by='TR_TRM_CATEGORY')
setnames(tmp,colnames(tmp),gsub('TR_','REC_',colnames(tmp)))
dobs<-merge(dobs,tmp,by='REC_TRM_CATEGORY')
dobs[, S:= TR_TRM_P_SEQ * REC_TRM_P_SEQ]
ds
dobs
N<-rpois(1,300/mean(dobs$S))
z<-rmultinom(1,size=N,prob=TRUE_PI)
n<-matrix(NA_integer_,ncol=1,nrow=length(TRUE_PI))
for (i in 1:length(TRUE_PI)){
n[i]<-rbinom(1,size=z[i],dobs$S[i])
}
dobs[, TRM_OBS:= n]
dobs.obs.zero<-which(dobs$TRM_OBS==0)
dobs<-dobs[TRM_OBS!=0,]
dobs[, TRM_CAT_PAIR_ID:= seq_len(nrow(dobs))]
# remove irrelevant terms
set(ds,NULL,c('P_SEQ','LOGIT_P_SEQ'),NULL)
set(dobs,NULL,c('TR_P_SEQ','REC_P_SEQ','S','TRUE_PI'),NULL)
dobs[,TR_COMM_NUM_B:=as.integer(TR_COMM_NUM_B)]
dobs[,REC_COMM_NUM_B:=as.integer(REC_COMM_NUM_B)]
ds
dobs
library(data.table)
library(gtools)
# library(phyloflows)
set.seed(42)
num.inf.1<-2000
num.inf.2<-2500
ds<-data.table(COMM_NUM_B=c(rep(1,num.inf.1),rep(2,num.inf.2)),INF=rep(1,num.inf.1+num.inf.2))
num.f.1<-round(num.inf.1*0.7)
num.m.1<-num.inf.1-round(num.inf.1*0.7)
num.f.2<-round(num.inf.2*0.6)
num.m.2<-num.inf.2-round(num.inf.2*0.6)
ds$SEX<-c(rep('F',num.f.1),
rep('M',num.m.1),
rep('F',num.f.2),
rep('M',num.m.2))
ds$AGE_AT_MID_C<-c(rep('15-24',round(num.f.1*0.25)),
rep('25-34',round(num.f.1*0.6)),
rep('35+',num.f.1-round(num.f.1*0.25)-round(num.f.1*0.6)),
rep('15-24',round(num.m.1*0.2)),
rep('25-34',round(num.m.1*0.5)),
rep('35+',num.m.1-round(num.m.1*0.2)-round(num.m.1*0.5)),
rep('15-24',round(num.f.2*0.25)),
rep('25-34',round(num.f.2*0.5)),
rep('35+',num.f.2-round(num.f.2*0.25)-round(num.f.2*0.5)),
rep('15-24',round(num.m.2*0.2)),
rep('25-34',round(num.m.2*0.4)),
rep('35+',num.m.2-round(num.m.2*0.2)-round(num.m.2*0.4))
)
ds		<- ds[, list(TRIAL=length(INF)),by=c('AGE_AT_MID_C','SEX','COMM_NUM_B')]
comm<-c(0.5,-0.5)
a<-0.4
male<-0.4
young<-0.3
midage<-0.2
ds[, AGE1:= as.integer(AGE_AT_MID_C=='15-24')]
ds[, AGE2:= as.integer(AGE_AT_MID_C=='25-34')]
ds[, MALE:= as.integer(SEX=='M')]
ds[,LOGIT_P_SEQ:=a + comm[COMM_NUM_B] + male*MALE + young*AGE1 + midage*AGE2]
ds[,P_SEQ:=exp(LOGIT_P_SEQ)/(1+exp(LOGIT_P_SEQ))]
ds[,SUC:=rbinom(nrow(ds),TRIAL,P_SEQ)]
ds[,CATEGORY:=paste0(COMM_NUM_B,':',SEX,':',AGE_AT_MID_C)]
ds[,COMM_NUM_B:=as.integer(COMM_NUM_B)]
dobs<-as.data.table(expand.grid(TR_TRM_CATEGORY=ds$CATEGORY,REC_TRM_CATEGORY=ds$CATEGORY))
dobs[, c("TR_COMM_NUM_B","TR_SEX", "TR_AGE_AT_MID_C") := tstrsplit(TR_TRM_CATEGORY, ":", fixed=TRUE)]
dobs[, c("REC_COMM_NUM_B","REC_SEX", "REC_AGE_AT_MID_C") := tstrsplit(REC_TRM_CATEGORY, ":", fixed=TRUE)]
dobs<-dobs[TR_SEX!=REC_SEX,]
dobs[,TRM_CAT_PAIR_ID:=seq_len(nrow(dobs))]
dobs
lbd   <- rnorm(nrow(dobs),2,0.2)
tmp   <- dobs[TR_COMM_NUM_B!=REC_COMM_NUM_B,TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
tmp   <- dobs[TR_COMM_NUM_B==REC_COMM_NUM_B & TR_SEX=='M' &
( (TR_AGE_AT_MID_C=='15-24' & REC_AGE_AT_MID_C=='25-34')|
(TR_AGE_AT_MID_C=='25-34' & REC_AGE_AT_MID_C=='35+')|
(TR_AGE_AT_MID_C=='15-24' & REC_AGE_AT_MID_C=='35+') ),TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
tmp   <- dobs[TR_COMM_NUM_B==REC_COMM_NUM_B & TR_SEX=='F' &
( (TR_AGE_AT_MID_C=='25-34' & REC_AGE_AT_MID_C=='15-24')|
(TR_AGE_AT_MID_C=='35+' & REC_AGE_AT_MID_C=='15-24')|
(TR_AGE_AT_MID_C=='35+' & REC_AGE_AT_MID_C=='25-34') ),TRM_CAT_PAIR_ID]
lbd[tmp]  <- rnorm(length(tmp),1,0.2)
TRUE_PI<-lbd/sum(lbd)
dobs[,TRUE_PI:=as.vector(TRUE_PI)]
tmp<-subset(ds,select=c('CATEGORY','P_SEQ'))
setnames(tmp,colnames(tmp),paste0('TR_TRM_',colnames(tmp)))
dobs<-merge(dobs,tmp,by='TR_TRM_CATEGORY')
setnames(tmp,colnames(tmp),gsub('TR_','REC_',colnames(tmp)))
dobs<-merge(dobs,tmp,by='REC_TRM_CATEGORY')
dobs[, S:= TR_TRM_P_SEQ * REC_TRM_P_SEQ]
N<-rpois(1,300/mean(dobs$S))
z<-rmultinom(1,size=N,prob=TRUE_PI)
n<-matrix(NA_integer_,ncol=1,nrow=length(TRUE_PI))
for (i in 1:length(TRUE_PI)){
n[i]<-rbinom(1,size=z[i],dobs$S[i])
}
dobs[, TRM_OBS:= n]
dobs.obs.zero<-which(dobs$TRM_OBS==0)
dobs<-dobs[TRM_OBS!=0,]
dobs[, TRM_CAT_PAIR_ID:= seq_len(nrow(dobs))]
ds
dobs
