---
title: "**phyloflow**"
author: "Xiaoyue Xi, Oliver Ratmann"
date: "2018-10-18"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
```{r, include=TRUE, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, tidy=TRUE}
require(knitr)
require(kableExtra)
require(ggplot2)
```

# **phyloflows**

**phyloflows** provides an MCMC algorithm to infer transmission flows within and
between population groups from observed flow counts. 

**phyloflows** was primarily written to estimate transmission flows from counts
of phylogenetically reconstructed likely transmission pairs, in whom the
direction of transmission could be inferred with high support. These input data
can be obtained with
[phyloscanner](https://github.com/BDI-pathogens/phyloscanner), though different
types of input data can also be used, so long as they represent observed counts
of flow events between two discrete groups. The primary feature of
**phyloflows** is that the underlying statistical model allows adjusting for
sampling heterogeneity across population groups while estimating transmission
flows, a common problem in molecular epidemiologic analyses.


## Getting started

If you are just getting started with **phyloflows**, why don t you take a look
at the tutorial vignettes.

## Installation

Install the latest development version from **GitHub**:

```{r, include=TRUE, eval=FALSE, echo=TRUE, tidy=FALSE}
install_github("BDI-pathogens/phyloscanner/phyloflows", dependencies=TRUE, build_vignettes=FALSE)
require(phyloflows)
```

If you have issues with installation/running of phyloflows, please raise an
Issue on the GitHub page and we will get back to you.

## The main idea
xxx

## Quick example
### Input data
**phyloflows** expects input data in a specific format. First, a data.frame
of observed transmission counts within and between population groups, which we
call `dobs`. Second a data.frame that summarises prior information on how
population groups were sampled, which we call `dprior`. 

To get you started, **phyloflows** comes with a small simulated example data set
of transmission counts and sampling information between two population groups,
denoted by "1" and "2":
```{r, include=TRUE, eval=TRUE, echo=TRUE, tidy=FALSE}
data(twoGroupFlows1)
dobs <- twoGroupFlows1$dobs
dprior <- twoGroupFlows1$dprior
```

Data.frame `dobs` must contain the columns *TR_TRM_CATEGORY*,
*REC_TRM_CATEGORY* and *TRM_OBS*. Each row specifies observed counts of
transmissions from a transmitter group to a recipient group. It also must
contain the columns *TR_SAMPLING_CATEGORY* and *REC_SAMPLING_CATEGORY*, which
associate each transmitter/recipient group with a sampling category. We will
get to this in a minute. For now, let us look at the data.frame. The first row
contains counts of transmission flows from group "1" to group "1", and there
are 139 of them. The next row contains counts of transmission flows from group
"1" to group "2", and there are 15 of them.

```{r, include=TRUE, eval=TRUE, echo=FALSE, tidy=FALSE}
kable(dobs, caption='Data frame containing observed transmission counts.') %>%
		kable_styling(full_width = F, position = "left", font_size = 5) %>%
		scroll_box(width = "100%", height = "200px")
```

Here is a barplot of our input data: 

```{r, include=TRUE, eval=TRUE, echo=FALSE, tidy=FALSE, out.width = "70%", fig.align="center"}
ggplot(dobs, aes(x=paste0(TR_TRM_CATEGORY,'->',REC_TRM_CATEGORY), y=TRM_OBS, fill=paste0(TR_TRM_CATEGORY,'->',REC_TRM_CATEGORY))) +
		geom_bar(stat='identity') +
		guides(fill='none') +
		theme_classic() +
		labs(x='transmission flows\n(from -> to)\n', y='\nobserved counts') +
		coord_flip()
```

Each transmitter/recipient group is associated to a sampling category. This can
be "sampling group a" for both "1" and "2", or "a" and "b" respectively for "1"
and "2". In our little data set, we gave the same name to transmitter/recipient
and sampling groups. Data.frame `dprior` specifies the probability of sampling
an individual from each sampling group. To keep this as flexible as possible,
samples from the sampling distribution, rather than say the mean and standard
deviation, need to be given. Data.frame `dprior` must contain the columns
*SAMPLING_CATEGORY*, *SAMPLE*, *P* and *LP*. *SAMPLING_CATEGORY* specifies the
sampling group; *SAMPLE* is just an ID specifying if it is the first, second,
... sample; *P* is the value of the sample, and *LP* is the log density of the
sample.

```{r, include=TRUE, eval=TRUE, echo=FALSE, tidy=FALSE}
kable(dprior, caption='Data frame containing samples from the sampling distribution for each sampling group.') %>%
		kable_styling(full_width = F, position = "left", font_size = 5) %>%
		scroll_box(width = "100%", height = "200px")
```

Here is a histogram of the sampling distribution from sampling groups "1" and
"2". Notice that in our example, the probability of sampling individuals in
group "1" is higher than that among individuals in group "2".


```{r, include=TRUE, eval=TRUE, echo=FALSE, tidy=FALSE, warning=FALSE, out.width = "70%", fig.align="center"}
ggplot(dprior, aes(x=P)) +
		geom_histogram(binwidth=0.005, alpha=0.5, fill='deepskyblue4') +
		theme_classic() +
		labs(x='\nsampling probability in group "1', y='observed counts\n') +
		scale_x_continuous(labels=scales:::percent, lim=c(0,1), expand=c(0,0)) +
		facet_grid(~SAMPLING_CATEGORY)
```

### MCMC algorithm 
xxx


